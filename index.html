<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARI KONSUL</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons for modern icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #e0f7fa;
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M 0,0 C 20,40 30,50 50,50 S 80,40 100,0 L 100,100 L 0,100 Z" fill="%23b3e5fc" opacity="0.4" /%3E%3C/svg%3E');
            background-size: 50px 50px;
        }

        .card-water {
            border: 4px solid #01579b;
            border-radius: 20px;
            box-shadow: 6px 6px 0px 0px #0277bd;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            transform: rotate(-1deg);
        }

        .card-water:hover {
            transform: rotate(0deg) scale(1.01);
            box-shadow: 3px 3px 0px 0px #0277bd;
        }

        .btn-water {
            border: 3px solid #01579b;
            border-radius: 12px;
            box-shadow: 4px 4px 0px 0px #0277bd;
            font-weight: 600;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .btn-water:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #0277bd;
        }

        .tab-water {
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-water.active {
            border-color: #00acc1;
            color: #00acc1;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0f7fa; }
        ::-webkit-scrollbar-thumb { background: #00acc1; border-radius: 4px; }
        
        .view {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .view.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none; /* Cegah interaksi saat hidden */
        }
         .view:not(.hidden) {
            pointer-events: auto;
        }


        .tab-content { transition: opacity 0.5s ease-in-out; }
        .tab-content.hidden { display: none; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Container Utama -->
    <div class="container mx-auto p-4 md:p-8 relative">

        <!-- 1. Tampilan Pemilihan Peran -->
        <div id="role-selection-view" class="view min-h-screen flex items-center justify-center">
            <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <div class="mx-auto mb-6 bg-blue-300 p-4 rounded-full w-24 h-24 flex items-center justify-center border-4 border-[#01579b] [transform:rotate(5deg)]">
                    <i data-lucide="droplets" class="w-16 h-16 text-[#01579b]"></i>
                </div>
                <h1 class="text-3xl font-bold text-[#01579b] mb-2">MARI KONSUL</h1>
                <p class="text-slate-600 mb-8">Pilih peranmu untuk masuk!</p>
        
                <div class="space-y-4">
                    <button id="show-login-siswa-btn" class="w-full bg-cyan-400 text-[#01579b] font-semibold py-3 px-4 rounded-lg hover:bg-cyan-500 btn-water flex items-center justify-center gap-2">
                        <i data-lucide="water" class="w-5 h-5"></i>
                        Masuk sebagai Siswa
                    </button>
                    <button id="show-login-guru-bk-btn" class="w-full bg-teal-400 text-[#01579b] font-semibold py-3 px-4 rounded-lg hover:bg-teal-500 btn-water flex items-center justify-center gap-2">
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                        Masuk sebagai Guru BK
                    </button>
                    <button id="show-login-admin-btn" class="w-full bg-blue-400 text-[#01579b] font-semibold py-3 px-4 rounded-lg hover:bg-blue-500 btn-water flex items-center justify-center gap-2">
                        <i data-lucide="anchor" class="w-5 h-5"></i>
                        Masuk sebagai Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- 1a. Tampilan Login Siswa -->
        <div id="student-login-view" class="view hidden min-h-screen flex items-center justify-center">
            <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <h2 class="text-2xl font-bold text-[#01579b] mb-6">Login Siswa</h2>
                <form id="student-login-form" class="space-y-4">
                    <input type="text" id="student-username-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Username" required>
                    <input type="password" id="student-password-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Password" required>
                    <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Login</button>
                </form>
                <p id="student-login-error" class="text-red-500 text-sm mt-2 hidden">Username atau password salah!</p>
                <button id="back-to-role-selection-btn" class="mt-4 text-sm text-slate-600 hover:text-blue-600">Kembali ke pemilihan peran</button>
            </div>
        </div>
        
        <!-- 1b. Tampilan Login Guru BK -->
        <div id="guru-bk-login-view" class="view hidden min-h-screen flex items-center justify-center">
            <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <h2 class="text-2xl font-bold text-teal-600 mb-6">Login Guru BK</h2>
                <form id="guru-bk-login-form" class="space-y-4">
                    <input type="text" id="guru-bk-username-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Username" required>
                    <input type="password" id="guru-bk-password-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Password" required>
                    <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 btn-water">Login</button>
                </form>
                <p id="guru-bk-login-error" class="text-red-500 text-sm mt-2 hidden">Username atau password salah!</p>
                <button id="back-to-role-selection-btn-guru" class="mt-4 text-sm text-slate-600 hover:text-blue-600">Kembali ke pemilihan peran</button>
            </div>
        </div>

        <!-- 1c. Tampilan Login Admin -->
        <div id="admin-login-view" class="view hidden min-h-screen flex items-center justify-center">
             <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <h2 class="text-2xl font-bold text-[#01579b] mb-6">Login Admin</h2>
                <form id="admin-login-form" class="space-y-4">
                    <input type="password" id="admin-password-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password rahasia..." required>
                    <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 btn-water">Masuk!</button>
                </form>
                <p id="admin-login-error" class="text-red-500 text-sm mt-2 hidden">Salah password, coba lagi ya!</p>
                <button id="back-to-role-selection-btn2" class="mt-4 text-sm text-slate-600 hover:text-blue-600">Kembali ke pemilihan peran</button>
            </div>
        </div>

        <!-- 2. Tampilan Dasbor Siswa -->
        <div id="siswa-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div class="inline-flex items-center gap-3 bg-white p-3 rounded-full shadow-lg border-4 border-[#01579b] [transform:rotate(3deg)]">
                    <i data-lucide="water" class="w-10 h-10 text-cyan-400"></i>
                    <div>
                        <h1 id="student-name-display" class="text-xl md:text-2xl font-bold text-cyan-500">Dasbor Siswa</h1>
                        <p id="student-id-display" class="text-xs text-slate-500"></p>
                    </div>
                </div>
                <button class="logout-btn text-sm text-slate-600 hover:text-red-500 flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>
            <main class="bg-white rounded-2xl shadow-2xl overflow-hidden card-water">
                <nav class="flex border-b-4 border-[#01579b]">
                    <button data-tab="jadwal" class="tab-water active flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Janji Temu</button>
                    <button data-tab="chat" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Chat Privat</button>
                    <button data-tab="materi" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Materi</button>
                    <!-- TAB BARU UNTUK LAPORAN SISWA -->
                    <button data-tab="laporan-bk" class="tab-water flex-1 p-4 text-center text-sm md:text-base">Laporan BK</button>
                </nav>
                <div class="p-4 md:p-8">
                    <div id="jadwal-siswa" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-6 rounded-lg border-4 border-[#01579b] [transform:rotate(2deg)]">
                                <h3 class="font-bold text-lg mb-4 text-blue-600">Formulir Janji Temu</h3>
                                <form id="appointment-form" class="space-y-4">
                                    <div><label for="kelas" class="block text-sm">Kelas</label><input type="text" id="kelas" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                                    <div><label for="topik" class="block text-sm">Topik Konseling</label><select id="topik" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]"><option>Masalah Akademik</option><option>Masalah Pribadi/Keluarga</option><option>Perencanaan Karir</option><option>Lainnya</option></select></div>
                                    <div><label for="tanggal" class="block text-sm">Pilih Tanggal & Waktu</label><input type="datetime-local" id="tanggal" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                                    <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Ajukan Jadwal</button>
                                </form>
                                <div id="success-message" class="hidden mt-4 p-3 bg-green-200 text-green-800 rounded-lg border-2 border-green-800">Jadwal berhasil diajukan!</div>
                            </div>
                            <div class="bg-teal-50 p-6 rounded-lg border-4 border-[#01579b] [transform:rotate(-2deg)]">
                                <h3 class="font-bold text-lg mb-4 text-teal-600">Jadwal Saya</h3>
                                <div id="appointment-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>
                    <div id="chat-siswa" class="tab-content hidden h-[60vh] flex flex-col">
                         <div class="p-4 bg-cyan-200 rounded-xl shadow-inner mb-4 text-center border-4 border-[#01579b]">
                            <p class="text-sm text-slate-700 mb-2 font-bold">Butuh bantuan cepat? Hubungi Guru BK via WhatsApp!</p>
                            <a href="https://wa.me/6281283322651" target="_blank" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 btn-water">
                                <i data-lucide="message-square-text" class="w-5 h-5"></i>
                                Chat sekarang!
                            </a>
                        </div>
                        <div id="chat-messages-siswa" class="flex-grow overflow-y-auto p-4 space-y-4 rounded-xl bg-blue-100 shadow-inner mb-4 border-4 border-[#01579b]"></div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input-siswa" placeholder="Kirim pesanmu..." class="flex-grow border-2 rounded-full px-4 py-2 border-[#01579b] focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="send-btn-siswa" class="bg-blue-400 text-[#01579b] rounded-full p-3 hover:bg-blue-500 btn-water">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div id="materi-siswa" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-cyan-600">Materi</h3>
                        <div id="materi-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                    <!-- KONTEN BARU UNTUK LAPORAN SISWA -->
                    <div id="laporan-bk-siswa" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-cyan-600">Laporan Kegiatan BK</h3>
                        <div id="laporan-bk-siswa-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            <!-- Reports will be rendered here -->
                        </div>
                    </div>
                    <!-- AKHIR KONTEN BARU -->
                </div>
            </main>
        </div>

        <!-- 3. Tampilan Dasbor Guru BK -->
        <div id="guru-bk-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div class="inline-flex items-center gap-3 bg-white p-3 rounded-full shadow-lg border-4 border-[#01579b] [transform:rotate(-3deg)]">
                    <i data-lucide="user-check" class="w-10 h-10 text-teal-500"></i>
                    <div>
                        <h1 id="guru-bk-name-display" class="text-xl md:text-2xl font-bold text-teal-600">Dasbor Guru BK</h1>
                        <p class="text-xs text-slate-500">Manajemen Konseling</p>
                    </div>
                </div>
                <button class="logout-btn text-sm text-slate-600 hover:text-red-500 flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>
            <main class="bg-white rounded-2xl shadow-2xl overflow-hidden card-water">
                <nav class="flex border-b-4 border-[#01579b]">
                    <button data-tab="jadwal" class="tab-water active flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Janji Temu</button>
                    <!-- Perubahan 1: Mengganti nama tab untuk memperjelas fitur komunikasi/masukan siswa -->
                    <button data-tab="chat" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Komunikasi Siswa</button>
                    <button data-tab="materi" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Materi</button>
                    <button data-tab="laporan-bk" class="tab-water flex-1 p-4 text-center text-sm md:text-base">Laporan</button>
                </nav>
                <div class="p-4 md:p-8">
                    <div id="jadwal-guru-bk" class="tab-content">
                        <h2 class="text-xl md:text-2xl font-bold text-teal-600 mb-6">Janji Temu Masuk</h2>
                        <div id="guru-bk-appointment-list" class="space-y-4"></div>
                    </div>
                    <div id="chat-guru-bk" class="tab-content hidden h-[60vh] flex flex-col">
                         <!-- Perubahan 2: Menambahkan judul yang lebih jelas untuk kotak masuk siswa -->
                         <h3 class="font-bold text-2xl mb-4 text-teal-600">Kotak Masuk Siswa</h3>
                         <div class="mb-4">
                            <label for="chat-student-select-guru" class="block text-sm font-bold text-slate-700">Pilih Siswa:</label>
                            <select id="chat-student-select-guru" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-2 border-[#01579b] focus:outline-none focus:ring-teal-500 sm:text-sm rounded-md"></select>
                         </div>
                        <div id="chat-messages-guru-bk" class="flex-grow overflow-y-auto p-4 space-y-4 rounded-xl bg-teal-50 shadow-inner mb-4 border-4 border-[#01579b]"></div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input-guru-bk" placeholder="Balas pesan siswa..." class="flex-grow border-2 rounded-full px-4 py-2 border-[#01579b] focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <button id="send-btn-guru-bk" class="bg-teal-400 text-[#01579b] rounded-full p-3 hover:bg-teal-500 btn-water">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div id="materi-guru-bk" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-cyan-600">Kelola Materi</h3>
                        <form id="materi-form-guru-bk" class="bg-cyan-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4">
                            <div><label for="materi-judul-guru-bk" class="block text-sm">Judul</label><input type="text" id="materi-judul-guru-bk" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="materi-konten-guru-bk" class="block text-sm">Konten</label><textarea id="materi-konten-guru-bk" rows="5" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></textarea></div>
                            <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Simpan Materi</button>
                        </form>
                        <hr class="my-8 border-t-2 border-[#01579b] border-dashed">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Daftar Materi</h3>
                        <div id="materi-list-guru-bk" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="laporan-bk-guru-bk" class="tab-content hidden">
                        <h3 class="font-bold text-lg mb-4 text-teal-600">Laporan Kegiatan Guru BK</h3>
                        <form id="laporan-bk-form-guru-bk" class="bg-teal-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4">
                            <div><label for="laporan-bk-kegiatan-guru-bk" class="block text-sm">Nama Kegiatan/Layanan</label><input type="text" id="laporan-bk-kegiatan-guru-bk" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="laporan-bk-deskripsi-guru-bk" class="block text-sm">Deskripsi Singkat</label><textarea id="laporan-bk-deskripsi-guru-bk" rows="3" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></textarea></div>
                            <div><label for="laporan-bk-tanggal-guru-bk" class="block text-sm">Tanggal Pelaksanaan</label><input type="date" id="laporan-bk-tanggal-guru-bk" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 btn-water">Simpan Laporan</button>
                        </form>
                        <hr class="my-8 border-t-2 border-[#01579b] border-dashed">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Riwayat Laporan</h3>
                        <div id="laporan-bk-list-guru-bk" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 4. Tampilan Dasbor Admin -->
        <div id="admin-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div class="inline-flex items-center gap-3 bg-white p-3 rounded-full shadow-lg border-4 border-[#01579b] [transform:rotate(-3deg)]">
                    <i data-lucide="anchor" class="w-10 h-10 text-blue-500"></i>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-blue-600">Dasbor Admin</h1>
                        <p class="text-xs text-slate-500">Manajemen Aplikasi</p>
                    </div>
                </div>
                <button class="logout-btn text-sm text-slate-600 hover:text-red-500 flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>
            <main class="bg-white rounded-2xl shadow-2xl overflow-hidden card-water">
                <nav class="flex border-b-4 border-[#01579b]">
                    <button data-tab="users" class="tab-water active flex-1 p-4 text-center text-sm md:text-base">Kelola User</button>
                </nav>
                <div class="p-4 md:p-8">
                    <!-- Tab Kelola User -->
                    <div id="users-admin" class="tab-content">
                        <h3 class="font-bold text-2xl mb-4 text-purple-600">Manajemen User</h3>
                         <form id="create-user-form" class="bg-purple-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4 mb-8">
                            <div>
                                <label for="user-role" class="block text-sm">Peran User</label>
                                <select id="user-role" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]">
                                    <option value="siswa">Siswa</option>
                                    <option value="guru-bk">Guru BK</option>
                                </select>
                            </div>
                            <div><label for="user-nama" class="block text-sm">Nama Lengkap</label><input type="text" id="user-nama" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="user-username" class="block text-sm">Username</label><input type="text" id="user-username" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="user-password" class="block text-sm">Password</label><input type="password" id="user-password" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <button type="submit" class="w-full bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 btn-water">Buat Akun</button>
                        </form>
                        <p class="text-sm text-slate-500 mb-6">Di sini Anda dapat melihat dan menghapus data user. Menghapus user akan menghapus semua data terkait (janji temu, chat, dll).</p>
                        <div id="user-list-admin" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // === Elemen Tampilan ===
            const roleSelectionView = document.getElementById('role-selection-view');
            const studentLoginView = document.getElementById('student-login-view');
            const guruBkLoginView = document.getElementById('guru-bk-login-view');
            const adminLoginView = document.getElementById('admin-login-view');
            const siswaView = document.getElementById('siswa-view');
            const guruBkView = document.getElementById('guru-bk-view');
            const adminView = document.getElementById('admin-view');

            // === Tombol Navigasi & Form Login ===
            const showLoginSiswaBtn = document.getElementById('show-login-siswa-btn');
            const showLoginGuruBkBtn = document.getElementById('show-login-guru-bk-btn');
            const showLoginAdminBtn = document.getElementById('show-login-admin-btn');
            const backToRoleBtns = document.querySelectorAll('#back-to-role-selection-btn, #back-to-role-selection-btn2, #back-to-role-selection-btn-guru');
            const logoutBtns = document.querySelectorAll('.logout-btn');

            const studentLoginForm = document.getElementById('student-login-form');
            const guruBkLoginForm = document.getElementById('guru-bk-login-form');
            const adminLoginForm = document.getElementById('admin-login-form');
            
            // === Fungsi Pengalih Tampilan ===
            const showView = (viewToShow) => {
                // Ensure all views are hidden initially
                [roleSelectionView, studentLoginView, guruBkLoginView, adminLoginView, siswaView, guruBkView, adminView].forEach(v => v.classList.add('hidden'));
                // Show the target view
                viewToShow.classList.remove('hidden');
            };

            const switchTab = (view, targetTabId) => {
                const tabs = view.querySelectorAll('.tab-water');
                const contents = view.querySelectorAll('.tab-content');

                tabs.forEach(t => t.classList.remove('active'));
                const targetTab = Array.from(tabs).find(t => t.getAttribute('data-tab') === targetTabId);
                if (targetTab) targetTab.classList.add('active');
                
                // Get the base ID (e.g., 'siswa' from 'siswa-view')
                const baseId = view.id.split('-')[0];

                contents.forEach(c => c.classList.add('hidden'));
                const targetContent = view.querySelector(`#${targetTabId}-${baseId}`);
                if(targetContent) targetContent.classList.remove('hidden');
            };

            // === Fungsi Bersama (Shared Functions) ===
            const getUserData = (id) => {
                const accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                return accounts.find(acc => acc.id === id);
            };

            const getStatusBadge = (status) => {
                switch (status) {
                    case 'Dikonfirmasi': return '<span class="text-xs font-bold bg-green-200 text-green-800 px-2 py-1 rounded-full border border-green-800">Dikonfirmasi</span>';
                    case 'Ditolak': return '<span class="text-xs font-bold bg-red-200 text-red-800 px-2 py-1 rounded-full border border-red-800">Ditolak</span>';
                    default: return '<span class="text-xs font-bold bg-blue-200 text-blue-800 px-2 py-1 rounded-full border border-blue-800">Menunggu</span>';
                }
            };
            
            const renderChatMessage = (message, sender, role) => {
                const isUser = sender === 'user';
                let messageClass, alignmentClass;

                if (role === 'siswa') {
                    // Siswa's outgoing messages are blue/cyan, incoming (from Guru) are white/default
                    messageClass = isUser ? 'bg-blue-400 text-[#01579b] ml-auto' : 'bg-white text-[#01579b]';
                    alignmentClass = isUser ? 'justify-end' : 'justify-start';
                } else { // guru-bk
                    // Guru BK's outgoing messages are teal/default, incoming (from Siswa) are white/default
                    // NOTE: In Guru BK view, 'user' refers to the GURU BK (the local user). 'other' refers to the STUDENT.
                    messageClass = isUser ? 'bg-teal-400 text-[#01579b] ml-auto' : 'bg-white text-[#01579b]';
                    alignmentClass = isUser ? 'justify-end' : 'justify-start';
                }

                return `
                    <div class="flex ${alignmentClass}">
                        <div class="max-w-xs md:max-w-sm rounded-xl p-3 shadow-md border-2 border-[#01579b] ${messageClass}">
                            ${message}
                        </div>
                    </div>
                `;
            };
            
            // Set up default accounts if none exist
            if (!localStorage.getItem('userAccounts')) {
                const defaultAccounts = [
                    { id: 'siswa-001', role: 'siswa', name: 'Budi Santoso', username: 'budi', password: '123' },
                    { id: 'siswa-002', role: 'siswa', name: 'Citra Dewi', username: 'citra', password: '123' },
                    { id: 'guru-bk-001', role: 'guru-bk', name: 'Ibu Rina', username: 'rina', password: '123' },
                ];
                localStorage.setItem('userAccounts', JSON.stringify(defaultAccounts));
            }


            // =============================
            // === LOGIKA UNTUK SISWA ======
            // =============================
            let studentId;
            const studentNameDisplay = document.getElementById('student-name-display');
            const studentIdDisplay = document.getElementById('student-id-display');
            
            function initSiswaView() {
                studentId = localStorage.getItem('currentUserId');
                if (!studentId) { showView(roleSelectionView); return; }
                const userData = getUserData(studentId);
                studentNameDisplay.textContent = `Selamat Datang, ${userData ? userData.name : 'Siswa'}`;
                studentIdDisplay.textContent = `ID Sesi: ${studentId}`;
                renderStudentAppointments();
                renderMateriListSiswa();
                renderStudentLaporanList(); // <--- PANGGIL FUNGSI LAPORAN UNTUK SISWA
                showView(siswaView);
            }
            
            const renderStudentAppointments = () => {
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const myAppointments = allAppointments.filter(app => app.studentId === studentId).sort((a,b) => new Date(b.date) - new Date(a.date));
                const appointmentList = document.getElementById('appointment-list');
                appointmentList.innerHTML = '';
                if (myAppointments.length === 0) {
                    appointmentList.innerHTML = '<p class="text-slate-500 text-center">Belum ada janji temu.</p>';
                    return;
                }
                myAppointments.forEach(app => {
                    const date = new Date(app.date);
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-[#01579b] flex items-center justify-between';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-blue-600">${app.topic}</p>
                            <p class="text-sm text-slate-500">${date.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}, ${date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})} WIB</p>
                        </div>
                        ${getStatusBadge(app.status)}`;
                    appointmentList.appendChild(el);
                });
            };

            const renderSiswaChat = () => {
                const allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                const myChat = allChats[studentId] || [];
                const chatMessagesSiswa = document.getElementById('chat-messages-siswa');
                chatMessagesSiswa.innerHTML = '';
                // Ensure chat is displayed based on sender: 'user' is Siswa, 'guru' is Guru BK
                myChat.forEach(chat => {
                    chatMessagesSiswa.innerHTML += renderChatMessage(chat.message, chat.sender === 'user' ? 'user' : 'other', 'siswa');
                });
                chatMessagesSiswa.scrollTop = chatMessagesSiswa.scrollHeight;
            };

            const renderMateriListSiswa = () => {
                const materiList = JSON.parse(localStorage.getItem('materi') || '[]');
                const materiListSiswa = document.getElementById('materi-list');
                materiListSiswa.innerHTML = '';
                if (materiList.length === 0) {
                    materiListSiswa.innerHTML = '<p class="text-center text-slate-500">Belum ada materi yang ditambahkan.</p>';
                    return;
                }
                materiList.forEach(materi => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-[#01579b] [transform:rotate(2deg)]';
                    el.innerHTML = `
                        <h4 class="font-bold text-lg text-cyan-600 mb-2">${materi.judul}</h4>
                        <p class="text-sm text-slate-700 leading-relaxed">${materi.konten}</p>
                    `;
                    materiListSiswa.appendChild(el);
                });
            };
            
            // FUNGSI BARU UNTUK LAPORAN SISWA
            const renderStudentLaporanList = () => {
                const laporanBk = JSON.parse(localStorage.getItem('laporanBk') || '[]').sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
                const listEl = document.getElementById('laporan-bk-siswa-list');
                listEl.innerHTML = '';
                if (laporanBk.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-slate-500">Belum ada laporan kegiatan BK yang dibagikan.</p>';
                    return;
                }
                laporanBk.forEach(laporan => {
                    const tanggal = new Date(laporan.tanggal).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-blue-50 rounded-lg shadow-md border-2 border-cyan-600 [transform:rotate(1deg)]';
                    el.innerHTML = `
                        <h4 class="font-bold text-lg text-teal-600 mb-1">${laporan.kegiatan}</h4>
                        <p class="text-xs text-slate-500 mb-2">Tanggal: ${tanggal}</p>
                        <p class="text-sm text-slate-700 leading-relaxed">${laporan.deskripsi}</p>
                    `;
                    listEl.appendChild(el);
                });
            };
            
            document.getElementById('appointment-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const userData = getUserData(studentId);
                const newAppointment = {
                    id: 'app-' + Date.now(), studentId, status: 'Menunggu',
                    name: userData ? userData.name : 'Unknown',
                    class: document.getElementById('kelas').value,
                    topic: document.getElementById('topik').value,
                    date: document.getElementById('tanggal').value,
                };
                allAppointments.push(newAppointment);
                localStorage.setItem('appointments', JSON.stringify(allAppointments));
                e.target.reset();
                const successMessage = document.getElementById('success-message');
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 3000);
                renderStudentAppointments();
            });

            document.getElementById('send-btn-siswa').addEventListener('click', () => {
                const chatInputSiswa = document.getElementById('chat-input-siswa');
                const message = chatInputSiswa.value.trim();
                if (message) {
                    let allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                    if (!allChats[studentId]) allChats[studentId] = [];
                    // Sender 'user' means the local user (Siswa)
                    allChats[studentId].push({ message, sender: 'user', timestamp: Date.now() });
                    localStorage.setItem('chats', JSON.stringify(allChats));
                    chatInputSiswa.value = '';
                    renderSiswaChat();
                }
            });
            document.getElementById('chat-input-siswa').addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    document.getElementById('send-btn-siswa').click();
                }
            });

            siswaView.querySelector('.tab-water[data-tab="jadwal"]').addEventListener('click', () => switchTab(siswaView, 'jadwal'));
            siswaView.querySelector('.tab-water[data-tab="chat"]').addEventListener('click', () => { switchTab(siswaView, 'chat'); renderSiswaChat(); });
            siswaView.querySelector('.tab-water[data-tab="materi"]').addEventListener('click', () => { switchTab(siswaView, 'materi'); renderMateriListSiswa(); });
            // LISTENER BARU UNTUK LAPORAN SISWA
            siswaView.querySelector('.tab-water[data-tab="laporan-bk"]').addEventListener('click', () => { switchTab(siswaView, 'laporan-bk'); renderStudentLaporanList(); });


            // =============================
            // === LOGIKA UNTUK GURU BK ====
            // =============================
            let guruBkId;
            let selectedStudentIdForGuru = null;
            
            function initGuruBkView() {
                guruBkId = localStorage.getItem('currentUserId');
                if (!guruBkId) { showView(roleSelectionView); return; }
                const userData = getUserData(guruBkId);
                document.getElementById('guru-bk-name-display').textContent = `Dasbor Guru: ${userData ? userData.name : 'Guru BK'}`;
                renderGuruBkAppointments();
                renderGuruBkChatUsers();
                renderGuruBkMateriList();
                renderGuruBkLaporanList();
                showView(guruBkView);
            }
            
            const renderGuruBkAppointments = () => {
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]').sort((a,b) => new Date(b.date) - new Date(a.date));
                const listEl = document.getElementById('guru-bk-appointment-list');
                listEl.innerHTML = '';
                if (allAppointments.length === 0) {
                    listEl.innerHTML = '<p class="text-slate-500 text-center py-8">Tidak ada janji temu yang masuk.</p>';
                    return;
                }
                allAppointments.forEach(app => {
                    const date = new Date(app.date);
                    const el = document.createElement('div');
                    el.className = 'bg-teal-50 border-4 border-[#01579b] p-4 rounded-lg grid grid-cols-1 md:grid-cols-4 gap-4 items-center [transform:rotate(1deg)]';
                    el.innerHTML = `
                        <div class="md:col-span-2">
                            <p class="font-bold text-teal-600">${app.name} <span class="font-normal text-slate-500">- ${app.class}</span></p>
                            <p class="text-sm text-cyan-600 font-bold">${app.topic}</p>
                        </div>
                        <div><p class="font-bold">${date.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}, ${date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</p>${getStatusBadge(app.status)}</div>
                        <div class="flex gap-2 justify-start md:justify-end">
                            ${app.status === 'Menunggu' ? `
                            <button data-id="${app.id}" data-action="approve" class="action-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 btn-water">Setujui</button>
                            <button data-id="${app.id}" data-action="reject" class="action-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 btn-water">Tolak</button>
                            ` : `<p class="text-sm text-slate-500">Telah direspon</p>`}
                        </div>`;
                    listEl.appendChild(el);
                    lucide.createIcons(); // Re-render icons after adding new elements
                });
            };

            const renderGuruBkChatUsers = () => {
                const allUsers = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                const students = allUsers.filter(u => u.role === 'siswa');
                const selectEl = document.getElementById('chat-student-select-guru');
                selectEl.innerHTML = '<option value="">Pilih Siswa...</option>';
                students.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = acc.name;
                    selectEl.appendChild(option);
                });
                // Set default selected student if available
                if (students.length > 0) {
                    // Only set if no student is selected yet or if the currently selected one is gone
                    if (!selectedStudentIdForGuru || !students.some(s => s.id === selectedStudentIdForGuru)) {
                       selectedStudentIdForGuru = students[0].id;
                    }
                    selectEl.value = selectedStudentIdForGuru;
                } else {
                    selectedStudentIdForGuru = null;
                }
                renderGuruBkChat();
            };

            const renderGuruBkChat = () => {
                const chatMessagesEl = document.getElementById('chat-messages-guru-bk');
                if (!selectedStudentIdForGuru) {
                    chatMessagesEl.innerHTML = '<p class="text-center text-slate-500 mt-8">Pilih siswa untuk memulai percakapan.</p>';
                    return;
                }
                const allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                const chatHistory = allChats[selectedStudentIdForGuru] || [];
                chatMessagesEl.innerHTML = '';
                // Ensure chat is displayed based on sender: 'user' is Siswa, 'guru' is Guru BK
                // In this view (Guru BK), we reverse the roles for renderChatMessage function
                chatHistory.forEach(chat => {
                    // If the original sender was 'user' (Siswa), it's 'other' (incoming) here.
                    // If the original sender was 'guru' (Guru BK), it's 'user' (outgoing) here.
                    const senderRole = chat.sender === 'user' ? 'other' : 'user';
                    chatMessagesEl.innerHTML += renderChatMessage(chat.message, senderRole, 'guru-bk');
                });
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            };

            const renderGuruBkMateriList = () => {
                const materiList = JSON.parse(localStorage.getItem('materi') || '[]');
                const listEl = document.getElementById('materi-list-guru-bk');
                listEl.innerHTML = '';
                 if (materiList.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-slate-500">Tidak ada materi yang tersimpan.</p>';
                    return;
                }
                materiList.forEach(materi => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-cyan-600 flex justify-between items-center [transform:rotate(-1deg)]';
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg text-cyan-600">${materi.judul}</h4>
                            <p class="text-sm text-slate-500 mt-1">${materi.konten.substring(0, 100)}...</p>
                        </div>
                        <button data-id="${materi.id}" class="delete-materi-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                             <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>`;
                    listEl.appendChild(el);
                    lucide.createIcons();
                });
            };

            const renderGuruBkLaporanList = () => {
                const laporanBk = JSON.parse(localStorage.getItem('laporanBk') || '[]').sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));
                const listEl = document.getElementById('laporan-bk-list-guru-bk');
                listEl.innerHTML = '';
                if (laporanBk.length === 0) {
                    listEl.innerHTML = '<p class="text-center text-slate-500">Tidak ada data laporan yang tersimpan.</p>';
                    return;
                }
                laporanBk.forEach(laporan => {
                    const el = document.createElement('div');
                    const tanggal = new Date(laporan.tanggal).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                    el.className = `p-4 bg-teal-100 rounded-lg shadow-sm flex justify-between items-center border-2 border-[#01579b]`;
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-teal-700">${laporan.kegiatan}</p>
                            <p class="text-sm text-slate-600">${laporan.deskripsi}</p>
                            <p class="text-xs text-slate-500 mt-1">${tanggal}</p>
                        </div>
                        <button data-id="${laporan.id}" class="delete-laporan-bk-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>`;
                    listEl.appendChild(el);
                    lucide.createIcons();
                });
            };

            guruBkView.addEventListener('click', (e) => {
                const actionBtn = e.target.closest('.action-btn');
                if (actionBtn) {
                    let allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    const id = actionBtn.dataset.id;
                    const action = actionBtn.dataset.action;
                    const appIndex = allAppointments.findIndex(app => app.id === id);
                    if (appIndex > -1) {
                        allAppointments[appIndex].status = action === 'approve' ? 'Dikonfirmasi' : 'Ditolak';
                        localStorage.setItem('appointments', JSON.stringify(allAppointments));
                        renderGuruBkAppointments();
                    }
                }
                
                // Hapus Materi
                const deleteMateriBtn = e.target.closest('.delete-materi-btn');
                if (deleteMateriBtn) {
                    const id = deleteMateriBtn.dataset.id;
                    let allMateri = JSON.parse(localStorage.getItem('materi') || '[]').filter(m => m.id !== id);
                    localStorage.setItem('materi', JSON.stringify(allMateri));
                    renderGuruBkMateriList();
                    // Juga perlu memperbarui tampilan materi siswa jika mereka sedang melihatnya
                    if (siswaView.classList.contains('view') && !siswaView.classList.contains('hidden')) {
                         renderMateriListSiswa();
                    }
                }
                // Hapus Laporan
                const deleteLaporanBtn = e.target.closest('.delete-laporan-bk-btn');
                if (deleteLaporanBtn) {
                    const id = deleteLaporanBtn.dataset.id;
                    let allLaporan = JSON.parse(localStorage.getItem('laporanBk') || '[]').filter(l => l.id !== id);
                    localStorage.setItem('laporanBk', JSON.stringify(allLaporan));
                    renderGuruBkLaporanList();
                    // Juga perlu memperbarui tampilan laporan siswa
                    if (siswaView.classList.contains('view') && !siswaView.classList.contains('hidden')) {
                         renderStudentLaporanList();
                    }
                }
            });

            document.getElementById('chat-student-select-guru').addEventListener('change', (e) => {
                selectedStudentIdForGuru = e.target.value;
                renderGuruBkChat();
            });

            document.getElementById('send-btn-guru-bk').addEventListener('click', () => {
                const chatInput = document.getElementById('chat-input-guru-bk');
                const message = chatInput.value.trim();
                if (message && selectedStudentIdForGuru) {
                    let allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                    if (!allChats[selectedStudentIdForGuru]) allChats[selectedStudentIdForGuru] = [];
                    // Sender 'guru' means the local user (Guru BK)
                    allChats[selectedStudentIdForGuru].push({ message, sender: 'guru', timestamp: Date.now() });
                    localStorage.setItem('chats', JSON.stringify(allChats));
                    chatInput.value = '';
                    renderGuruBkChat();
                }
            });
            document.getElementById('chat-input-guru-bk').addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                    document.getElementById('send-btn-guru-bk').click();
                }
            });

            document.getElementById('materi-form-guru-bk').addEventListener('submit', (e) => {
                e.preventDefault();
                const allMateri = JSON.parse(localStorage.getItem('materi') || '[]');
                const newMateri = {
                    id: 'materi-' + Date.now(),
                    judul: document.getElementById('materi-judul-guru-bk').value,
                    konten: document.getElementById('materi-konten-guru-bk').value,
                };
                allMateri.push(newMateri);
                localStorage.setItem('materi', JSON.stringify(allMateri));
                e.target.reset();
                renderGuruBkMateriList();
                // Perbarui tampilan materi siswa secara langsung
                if (siswaView.classList.contains('view') && !siswaView.classList.contains('hidden')) {
                    renderMateriListSiswa();
                }
            });

             document.getElementById('laporan-bk-form-guru-bk').addEventListener('submit', (e) => {
                e.preventDefault();
                const laporanBk = JSON.parse(localStorage.getItem('laporanBk') || '[]');
                const newLaporan = {
                    id: 'laporan-' + Date.now(),
                    kegiatan: document.getElementById('laporan-bk-kegiatan-guru-bk').value,
                    deskripsi: document.getElementById('laporan-bk-deskripsi-guru-bk').value,
                    tanggal: document.getElementById('laporan-bk-tanggal-guru-bk').value,
                };
                laporanBk.push(newLaporan);
                localStorage.setItem('laporanBk', JSON.stringify(laporanBk));
                e.target.reset();
                renderGuruBkLaporanList();
                // Perbarui tampilan laporan siswa secara langsung
                 if (siswaView.classList.contains('view') && !siswaView.classList.contains('hidden')) {
                    renderStudentLaporanList();
                }
            });
            
            guruBkView.querySelectorAll('.tab-water').forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.dataset.tab;
                    switchTab(guruBkView, targetTab);
                    if (targetTab === 'jadwal') renderGuruBkAppointments();
                    if (targetTab === 'chat') renderGuruBkChatUsers();
                    if (targetTab === 'materi') renderGuruBkMateriList();
                    if (targetTab === 'laporan-bk') renderGuruBkLaporanList();
                });
            });

            // =============================
            // === LOGIKA UNTUK ADMIN ======
            // =============================
            const adminPassword = 'admin123';

            function initAdminView() {
                renderUserListAdmin();
                showView(adminView);
            }
            
            const renderUserListAdmin = () => {
                const allAccounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                const userListAdmin = document.getElementById('user-list-admin');
                userListAdmin.innerHTML = '';
                if (allAccounts.length === 0) {
                    userListAdmin.innerHTML = '<p class="text-center text-slate-500">Belum ada akun yang dibuat.</p>';
                    return;
                }
                allAccounts.forEach(acc => {
                    const el = document.createElement('div');
                    const roleBadge = acc.role === 'siswa' 
                        ? '<span class="text-xs bg-cyan-200 text-cyan-800 px-2 py-1 rounded-full">Siswa</span>' 
                        : '<span class="text-xs bg-teal-200 text-teal-800 px-2 py-1 rounded-full">Guru BK</span>';

                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-purple-600 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg text-purple-600">${acc.name}</h4>
                            <p class="text-xs text-slate-500">Username: ${acc.username}</p>
                        </div>
                        <div class="flex items-center gap-4">
                            ${roleBadge}
                            <button data-id="${acc.id}" class="delete-user-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>`;
                    userListAdmin.appendChild(el);
                    lucide.createIcons();
                });
            };

            document.getElementById('create-user-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                const username = document.getElementById('user-username').value;
                if (accounts.some(acc => acc.username === username)) {
                    alert('Username sudah digunakan!');
                    return;
                }
                const newAccount = {
                    id: (document.getElementById('user-role').value) + '-' + Date.now(),
                    role: document.getElementById('user-role').value,
                    name: document.getElementById('user-nama').value,
                    username: username,
                    password: document.getElementById('user-password').value,
                };
                accounts.push(newAccount);
                localStorage.setItem('userAccounts', JSON.stringify(accounts));
                e.target.reset();
                renderUserListAdmin();
            });

            document.getElementById('user-list-admin').addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-user-btn');
                if (deleteBtn) {
                    const idToDelete = deleteBtn.dataset.id;
                    let accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]').filter(acc => acc.id !== idToDelete);
                    localStorage.setItem('userAccounts', JSON.stringify(accounts));
                    if (idToDelete.startsWith('siswa')) {
                        let appointments = JSON.parse(localStorage.getItem('appointments') || '[]').filter(app => app.studentId !== idToDelete);
                        localStorage.setItem('appointments', JSON.stringify(appointments));
                        let chats = JSON.parse(localStorage.getItem('chats') || '{}');
                        delete chats[idToDelete];
                        localStorage.setItem('chats', JSON.stringify(chats));
                        // Jika siswa yang dihapus sedang dipilih oleh Guru BK
                        if (selectedStudentIdForGuru === idToDelete) {
                            selectedStudentIdForGuru = null;
                            // Perlu update tampilan Guru BK jika sedang terbuka
                            if (guruBkView.classList.contains('view') && !guruBkView.classList.contains('hidden')) {
                                renderGuruBkChatUsers();
                            }
                        }
                    }
                    renderUserListAdmin();
                }
            });

            // ======================================
            // === KONTROL NAVIGASI & INISIASI ======
            // ======================================
            showLoginSiswaBtn.addEventListener('click', () => showView(studentLoginView));
            showLoginGuruBkBtn.addEventListener('click', () => showView(guruBkLoginView));
            showLoginAdminBtn.addEventListener('click', () => showView(adminLoginView));
            backToRoleBtns.forEach(btn => btn.addEventListener('click', () => showView(roleSelectionView)));

            studentLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.elements['student-username-input'].value;
                const password = e.target.elements['student-password-input'].value;
                const accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                const account = accounts.find(acc => acc.role === 'siswa' && acc.username === username && acc.password === password);
                const errorEl = document.getElementById('student-login-error');
                if (account) {
                    errorEl.classList.add('hidden');
                    localStorage.setItem('userRole', 'siswa');
                    localStorage.setItem('currentUserId', account.id);
                    initSiswaView();
                } else {
                    errorEl.classList.remove('hidden');
                }
            });

            guruBkLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = e.target.elements['guru-bk-username-input'].value;
                const password = e.target.elements['guru-bk-password-input'].value;
                const accounts = JSON.parse(localStorage.getItem('userAccounts') || '[]');
                const account = accounts.find(acc => acc.role === 'guru-bk' && acc.username === username && acc.password === password);
                const errorEl = document.getElementById('guru-bk-login-error');
                if (account) {
                    errorEl.classList.add('hidden');
                    localStorage.setItem('userRole', 'guru-bk');
                    localStorage.setItem('currentUserId', account.id);
                    initGuruBkView();
                } else {
                    errorEl.classList.remove('hidden');
                }
            });
            
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const password = e.target.elements['admin-password-input'].value;
                const errorEl = document.getElementById('admin-login-error');
                if (password === adminPassword) {
                    errorEl.classList.add('hidden');
                    localStorage.setItem('userRole', 'admin');
                    initAdminView();
                } else {
                    errorEl.classList.remove('hidden');
                    e.target.reset();
                }
            });

            logoutBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('currentUserId');
                    showView(roleSelectionView);
                });
            });

            // Inisiasi saat halaman dimuat
            const savedRole = localStorage.getItem('userRole');
            if (savedRole === 'siswa') {
                initSiswaView();
            } else if (savedRole === 'guru-bk') {
                initGuruBkView();
            } else if (savedRole === 'admin') {
                initAdminView();
            } else {
                showView(roleSelectionView);
            }
        });
    </script>
</body>
</html>
