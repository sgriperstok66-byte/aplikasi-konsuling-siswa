<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MARI KONSUL</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons for modern icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #e0f7fa;
            background-image: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M 0,0 C 20,40 30,50 50,50 S 80,40 100,0 L 100,100 L 0,100 Z" fill="%23b3e5fc" opacity="0.4" /%3E%3C/svg%3E');
            background-size: 50px 50px;
        }

        .card-water {
            border: 4px solid #01579b;
            border-radius: 20px;
            box-shadow: 6px 6px 0px 0px #0277bd;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            transform: rotate(-1deg);
        }

        .card-water:hover {
            transform: rotate(0deg) scale(1.01);
            box-shadow: 3px 3px 0px 0px #0277bd;
        }

        .btn-water {
            border: 3px solid #01579b;
            border-radius: 12px;
            box-shadow: 4px 4px 0px 0px #0277bd;
            font-weight: 600;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
        }

        .btn-water:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px #0277bd;
        }

        .tab-water {
            font-weight: 600;
            border-bottom: 4px solid transparent;
            transition: all 0.2s ease;
        }
        .tab-water.active {
            border-color: #00acc1;
            color: #00acc1;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0f7fa; }
        ::-webkit-scrollbar-thumb { background: #00acc1; border-radius: 4px; }
        
        .view {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .view.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none; /* Cegah interaksi saat hidden */
        }
         .view:not(.hidden) {
            pointer-events: auto;
        }


        .tab-content { transition: opacity 0.5s ease-in-out; }
        .tab-content.hidden { display: none; }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Container Utama -->
    <div class="container mx-auto p-4 md:p-8 relative">

        <!-- 1. Tampilan Pemilihan Peran -->
        <div id="role-selection-view" class="view min-h-screen flex items-center justify-center">
            <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <div class="mx-auto mb-6 bg-blue-300 p-4 rounded-full w-24 h-24 flex items-center justify-center border-4 border-[#01579b] [transform:rotate(5deg)]">
                    <i data-lucide="droplets" class="w-16 h-16 text-[#01579b]"></i>
                </div>
                <h1 class="text-3xl font-bold text-[#01579b] mb-2">MARI KONSUL</h1>
                <p class="text-slate-600 mb-8">Pilih peranmu untuk masuk!</p>
        
                <div class="space-y-4">
                    <button id="show-login-siswa-btn" class="w-full bg-cyan-400 text-[#01579b] font-semibold py-3 px-4 rounded-lg hover:bg-cyan-500 btn-water flex items-center justify-center gap-2">
                        <i data-lucide="water" class="w-5 h-5"></i>
                        Masuk sebagai Siswa
                    </button>
                    <button id="show-login-admin-btn" class="w-full bg-blue-400 text-[#01579b] font-semibold py-3 px-4 rounded-lg hover:bg-blue-500 btn-water flex items-center justify-center gap-2">
                        <i data-lucide="anchor" class="w-5 h-5"></i>
                        Masuk sebagai Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- 1a. Tampilan Login Siswa -->
        <div id="student-login-view" class="view hidden min-h-screen flex items-center justify-center">
            <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <h2 class="text-2xl font-bold text-[#01579b] mb-6">Login Siswa</h2>
                <form id="student-login-form" class="space-y-4">
                    <input type="text" id="student-username-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Username" required>
                    <input type="password" id="student-password-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Password" required>
                    <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Login</button>
                </form>
                <p id="student-login-error" class="text-red-500 text-sm mt-2 hidden">Username atau password salah!</p>
                <button id="back-to-role-selection-btn" class="mt-4 text-sm text-slate-600 hover:text-blue-600">Kembali ke pemilihan peran</button>
            </div>
        </div>

        <!-- 1b. Tampilan Login Admin -->
        <div id="admin-login-view" class="view hidden min-h-screen flex items-center justify-center">
             <div class="text-center bg-white p-8 md:p-12 rounded-2xl shadow-2xl max-w-md w-full mx-4 card-water">
                <h2 class="text-2xl font-bold text-[#01579b] mb-6">Login Admin</h2>
                <form id="admin-login-form" class="space-y-4">
                    <input type="password" id="admin-password-input" class="w-full px-4 py-2 rounded-lg border-2 border-[#01579b] bg-white text-[#01579b] focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Password rahasia..." required>
                    <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 btn-water">Masuk!</button>
                </form>
                <p id="admin-login-error" class="text-red-500 text-sm mt-2 hidden">Salah password, coba lagi ya!</p>
                <button id="back-to-role-selection-btn2" class="mt-4 text-sm text-slate-600 hover:text-blue-600">Kembali ke pemilihan peran</button>
            </div>
        </div>

        <!-- 2. Tampilan Dasbor Siswa -->
        <div id="siswa-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div class="inline-flex items-center gap-3 bg-white p-3 rounded-full shadow-lg border-4 border-[#01579b] [transform:rotate(3deg)]">
                    <i data-lucide="water" class="w-10 h-10 text-cyan-400"></i>
                    <div>
                        <h1 id="student-name-display" class="text-xl md:text-2xl font-bold text-cyan-500">Dasbor Siswa</h1>
                        <p id="student-id-display" class="text-xs text-slate-500"></p>
                    </div>
                </div>
                <button class="logout-btn text-sm text-slate-600 hover:text-red-500 flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>
            <main class="bg-white rounded-2xl shadow-2xl overflow-hidden card-water">
                <nav class="flex border-b-4 border-[#01579b]">
                    <button data-tab="jadwal" class="tab-water active flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Janji Temu</button>
                    <button data-tab="chat" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Chat Privat</button>
                    <button data-tab="materi" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Materi</button>
                    <button data-tab="transparansi" class="tab-water flex-1 p-4 text-center text-sm md:text-base">Transparansi OSIS</button>
                </nav>
                <div class="p-4 md:p-8">
                    <div id="jadwal-siswa" class="tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-6 rounded-lg border-4 border-[#01579b] [transform:rotate(2deg)]">
                                <h3 class="font-bold text-lg mb-4 text-blue-600">Formulir Janji Temu</h3>
                                <form id="appointment-form" class="space-y-4">
                                    <div><label for="kelas" class="block text-sm">Kelas</label><input type="text" id="kelas" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                                    <div><label for="topik" class="block text-sm">Topik Konseling</label><select id="topik" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]"><option>Masalah Akademik</option><option>Masalah Pribadi/Keluarga</option><option>Perencanaan Karir</option><option>Lainnya</option></select></div>
                                    <div><label for="tanggal" class="block text-sm">Pilih Tanggal & Waktu</label><input type="datetime-local" id="tanggal" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                                    <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Ajukan Jadwal</button>
                                </form>
                                <div id="success-message" class="hidden mt-4 p-3 bg-green-200 text-green-800 rounded-lg border-2 border-green-800">Jadwal berhasil diajukan!</div>
                            </div>
                            <div class="bg-teal-50 p-6 rounded-lg border-4 border-[#01579b] [transform:rotate(-2deg)]">
                                <h3 class="font-bold text-lg mb-4 text-teal-600">Jadwal Saya</h3>
                                <div id="appointment-list" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>
                    <div id="chat-siswa" class="tab-content hidden h-[60vh] flex flex-col">
                         <div class="p-4 bg-cyan-200 rounded-xl shadow-inner mb-4 text-center border-4 border-[#01579b]">
                            <p class="text-sm text-slate-700 mb-2 font-bold">Butuh bantuan cepat? Hubungi admin via WhatsApp!</p>
                            <a href="https://wa.me/6281283322651" target="_blank" class="inline-flex items-center gap-2 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 btn-water">
                                <i data-lucide="message-square-text" class="w-5 h-5"></i>
                                Chat sekarang!
                            </a>
                        </div>
                        <div id="chat-messages-siswa" class="flex-grow overflow-y-auto p-4 space-y-4 rounded-xl bg-blue-100 shadow-inner mb-4 border-4 border-[#01579b]"></div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input-siswa" placeholder="Kirim pesanmu..." class="flex-grow border-2 rounded-full px-4 py-2 border-[#01579b] focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="send-btn-siswa" class="bg-blue-400 text-[#01579b] rounded-full p-3 hover:bg-blue-500 btn-water">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div id="materi-siswa" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-cyan-600">Materi</h3>
                        <div id="materi-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div id="transparansi-siswa" class="tab-content hidden">
                        <h2 class="font-bold text-2xl text-blue-600 mb-4">Transparansi OSIS</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="font-bold text-lg mb-4 text-cyan-600">Daftar Proposal Kegiatan</h3>
                                <div id="proposal-list-siswa" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg mb-4 text-teal-600">Laporan Keuangan</h3>
                                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-around border-4 border-[#01579b] [transform:rotate(2deg)]">
                                    <div class="text-center"><p class="text-sm text-slate-500">Total Pemasukan</p><p id="total-pemasukan-siswa" class="text-lg font-bold text-green-600"></p></div>
                                    <div class="text-center"><p class="text-sm text-slate-500">Total Pengeluaran</p><p id="total-pengeluaran-siswa" class="text-lg font-bold text-red-600"></p></div>
                                    <div class="text-center"><p class="text-sm text-slate-500">Saldo Akhir</p><p id="saldo-akhir-siswa" class="text-lg font-bold text-blue-600"></p></div>
                                </div>
                                <div id="keuangan-list-siswa" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 3. Tampilan Dasbor Admin -->
        <div id="admin-view" class="view hidden">
            <header class="flex justify-between items-center mb-8">
                <div class="inline-flex items-center gap-3 bg-white p-3 rounded-full shadow-lg border-4 border-[#01579b] [transform:rotate(-3deg)]">
                    <i data-lucide="anchor" class="w-10 h-10 text-blue-500"></i>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-blue-600">Dasbor Admin</h1>
                        <p class="text-xs text-slate-500">Manajemen Aplikasi</p>
                    </div>
                </div>
                <button class="logout-btn text-sm text-slate-600 hover:text-red-500 flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    Keluar
                </button>
            </header>
            <main class="bg-white rounded-2xl shadow-2xl overflow-hidden card-water">
                <nav class="flex border-b-4 border-[#01579b]">
                    <button data-tab="jadwal" class="tab-water active flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Janji Temu</button>
                    <button data-tab="chat" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Chat Privat</button>
                    <button data-tab="materi" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Materi</button>
                    <button data-tab="proposal" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Proposal OSIS</button>
                    <button data-tab="keuangan" class="tab-water flex-1 p-4 text-center text-sm md:text-base border-r border-dashed border-[#01579b]">Laporan Keuangan</button>
                    <button data-tab="users" class="tab-water flex-1 p-4 text-center text-sm md:text-base">Kelola User</button>
                </nav>
                <div class="p-4 md:p-8">
                    <!-- Tab Janji Temu -->
                    <div id="jadwal-admin" class="tab-content">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl md:text-2xl font-bold text-blue-600">Janji Temu Masuk</h2>
                            <button id="refresh-btn" class="text-slate-500 hover:text-blue-600"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
                        </div>
                        <div id="admin-appointment-list" class="space-y-4"></div>
                    </div>
                    <!-- Tab Chat Privat -->
                    <div id="chat-admin" class="tab-content hidden h-[60vh] flex flex-col">
                         <div id="student-list-chat" class="mb-4">
                            <label for="chat-student-select" class="block text-sm font-bold text-slate-700">Pilih Siswa:</label>
                            <select id="chat-student-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-2 border-[#01579b] focus:outline-none focus:ring-blue-500 sm:text-sm rounded-md"></select>
                         </div>
                        <div id="chat-messages-admin" class="flex-grow overflow-y-auto p-4 space-y-4 rounded-xl bg-blue-100 shadow-inner mb-4 border-4 border-[#01579b]"></div>
                        <div class="flex gap-2">
                            <input type="text" id="chat-input-admin" placeholder="Balas pesan siswa..." class="flex-grow border-2 rounded-full px-4 py-2 border-[#01579b] focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <button id="send-btn-admin" class="bg-cyan-400 text-[#01579b] rounded-full p-3 hover:bg-cyan-500 btn-water">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <!-- Tab Materi Motivasi -->
                    <div id="materi-admin" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-cyan-600">Kelola Materi</h3>
                        <form id="materi-form" class="bg-cyan-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4">
                            <div><label for="materi-judul" class="block text-sm">Judul</label><input type="text" id="materi-judul" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="materi-konten" class="block text-sm">Konten</label><textarea id="materi-konten" rows="5" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></textarea></div>
                            <button type="submit" class="w-full bg-cyan-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-cyan-600 btn-water">Simpan Materi</button>
                        </form>
                        <hr class="my-8 border-t-2 border-[#01579b] border-dashed">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Daftar Materi</h3>
                        <div id="materi-list-admin" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                    <!-- Tab Proposal OSIS -->
                    <div id="proposal-admin" class="tab-content hidden">
                        <h3 class="font-bold text-lg mb-4 text-blue-600">Kelola Proposal Kegiatan</h3>
                        <form id="proposal-form" class="bg-blue-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4">
                            <div><label for="proposal-nama-kegiatan" class="block text-sm">Nama Kegiatan</label><input type="text" id="proposal-nama-kegiatan" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="proposal-deskripsi" class="block text-sm">Deskripsi</label><textarea id="proposal-deskripsi" rows="5" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></textarea></div>
                            <div><label for="proposal-anggaran" class="block text-sm">Anggaran Dana</label><input type="number" id="proposal-anggaran" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <button type="submit" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 btn-water">Simpan Proposal</button>
                        </form>
                        <hr class="my-8 border-t-2 border-[#01579b] border-dashed">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Daftar Proposal</h3>
                        <div id="proposal-list-admin" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                    <!-- Tab Laporan Keuangan -->
                    <div id="keuangan-admin" class="tab-content hidden">
                        <h3 class="font-bold text-lg mb-4 text-teal-600">Laporan Keuangan OSIS</h3>
                        <form id="keuangan-form" class="bg-teal-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4">
                            <div><label for="keuangan-deskripsi" class="block text-sm">Deskripsi Transaksi</label><input type="text" id="keuangan-deskripsi" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div>
                                <label class="block text-sm">Jenis Transaksi</label>
                                <select id="keuangan-jenis" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]">
                                    <option value="pemasukan">Pemasukan</option>
                                    <option value="pengeluaran">Pengeluaran</option>
                                </select>
                            </div>
                            <div><label for="keuangan-jumlah" class="block text-sm">Jumlah</label><input type="number" id="keuangan-jumlah" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <button type="submit" class="w-full bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 btn-water">Simpan Transaksi</button>
                        </form>
                        <hr class="my-8 border-t-2 border-[#01579b] border-dashed">
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Ringkasan Keuangan</h3>
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-around border-4 border-[#01579b] [transform:rotate(-2deg)]">
                            <div class="text-center"><p class="text-sm text-slate-500">Total Pemasukan</p><p id="total-pemasukan-admin" class="text-lg font-bold text-green-600"></p></div>
                            <div class="text-center"><p class="text-sm text-slate-500">Total Pengeluaran</p><p id="total-pengeluaran-admin" class="text-lg font-bold text-red-600"></p></div>
                            <div class="text-center"><p class="text-sm text-slate-500">Saldo Akhir</p><p id="saldo-akhir-admin" class="text-lg font-bold text-blue-600"></p></div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Riwayat Transaksi</h3>
                        <div id="keuangan-list-admin" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                    <!-- Tab Kelola User -->
                    <div id="users-admin" class="tab-content hidden">
                        <h3 class="font-bold text-2xl mb-4 text-purple-600">Manajemen User Siswa</h3>
                         <form id="create-user-form" class="bg-purple-50 p-6 rounded-lg border-4 border-[#01579b] space-y-4 mb-8">
                            <div><label for="user-nama" class="block text-sm">Nama Lengkap Siswa</label><input type="text" id="user-nama" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="user-username" class="block text-sm">Username</label><input type="text" id="user-username" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <div><label for="user-password" class="block text-sm">Password</label><input type="password" id="user-password" class="mt-1 block w-full px-3 py-2 border-2 rounded-md border-[#01579b]" required></div>
                            <button type="submit" class="w-full bg-purple-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-600 btn-water">Buat Akun Siswa</button>
                        </form>
                        <p class="text-sm text-slate-500 mb-6">Di sini Anda dapat melihat dan menghapus data siswa. Menghapus user akan menghapus semua data terkait, termasuk janji temu dan riwayat chat.</p>
                        <div id="user-list-admin" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // === Elemen Tampilan ===
            const roleSelectionView = document.getElementById('role-selection-view');
            const studentLoginView = document.getElementById('student-login-view');
            const adminLoginView = document.getElementById('admin-login-view');
            const siswaView = document.getElementById('siswa-view');
            const adminView = document.getElementById('admin-view');

            const studentLoginForm = document.getElementById('student-login-form');
            const studentUsernameInput = document.getElementById('student-username-input');
            const studentPasswordInput = document.getElementById('student-password-input');
            const studentLoginError = document.getElementById('student-login-error');
            
            const adminLoginForm = document.getElementById('admin-login-form');
            const adminPasswordInput = document.getElementById('admin-password-input');
            const adminLoginError = document.getElementById('admin-login-error');

            const showLoginSiswaBtn = document.getElementById('show-login-siswa-btn');
            const showLoginAdminBtn = document.getElementById('show-login-admin-btn');
            const backToRoleBtns = document.querySelectorAll('#back-to-role-selection-btn, #back-to-role-selection-btn2');
            const logoutBtns = document.querySelectorAll('.logout-btn');

            const siswaTabs = siswaView.querySelectorAll('.tab-water');
            const siswaTabContents = siswaView.querySelectorAll('.tab-content');
            const adminTabs = adminView.querySelectorAll('.tab-water');
            const adminTabContents = adminView.querySelectorAll('.tab-content');

            // === Fungsi Pengalih Tampilan ===
            const showView = (viewToShow) => {
                [roleSelectionView, studentLoginView, adminLoginView, siswaView, adminView].forEach(v => v.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
            };

            const switchTab = (tabs, contents, targetTabId) => {
                tabs.forEach(t => t.classList.remove('active'));
                const targetTab = Array.from(tabs).find(t => t.getAttribute('data-tab') === targetTabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                contents.forEach(c => c.classList.add('hidden'));
                const targetContentId = targetTabId + (tabs === siswaTabs ? '-siswa' : '-admin');
                const targetContentElement = document.getElementById(targetContentId);
                if (targetContentElement) {
                    targetContentElement.classList.remove('hidden');
                }
            };

            // === Fungsi Bersama (Shared Functions) ===
            const getStudentData = (id) => {
                const accounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                return accounts.find(acc => acc.id === id);
            };
            
            const getStudentName = (id) => {
                const studentData = getStudentData(id);
                return studentData ? studentData.name : id;
            };

            const getStatusBadge = (status) => {
                switch (status) {
                    case 'Dikonfirmasi': return '<span class="text-xs font-bold bg-green-200 text-green-800 px-2 py-1 rounded-full border border-green-800">Dikonfirmasi</span>';
                    case 'Ditolak': return '<span class="text-xs font-bold bg-red-200 text-red-800 px-2 py-1 rounded-full border border-red-800">Ditolak</span>';
                    default: return '<span class="text-xs font-bold bg-blue-200 text-blue-800 px-2 py-1 rounded-full border border-blue-800">Menunggu</span>';
                }
            };

            const renderChatMessage = (message, sender) => {
                const isUser = sender === 'user';
                const messageClass = isUser ? 'bg-blue-400 text-[#01579b] ml-auto' : 'bg-white text-[#01579b]';
                const alignmentClass = isUser ? 'justify-end' : 'justify-start';
                return `
                    <div class="flex ${alignmentClass}">
                        <div class="max-w-xs md:max-w-sm rounded-xl p-3 shadow-md border-2 border-[#01579b] ${messageClass}">
                            ${message}
                        </div>
                    </div>
                `;
            };

            // === Format Rupiah ===
            const formatRupiah = (number) => {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
            };

            // =============================
            // === LOGIKA UNTUK SISWA ======
            // =============================
            const studentIdDisplay = document.getElementById('student-id-display');
            const studentNameDisplay = document.getElementById('student-name-display');
            const appointmentForm = document.getElementById('appointment-form');
            const appointmentList = document.getElementById('appointment-list');
            const successMessage = document.getElementById('success-message');
            const chatMessagesSiswa = document.getElementById('chat-messages-siswa');
            const chatInputSiswa = document.getElementById('chat-input-siswa');
            const sendBtnSiswa = document.getElementById('send-btn-siswa');
            const materiListSiswa = document.getElementById('materi-list');
            const proposalListSiswa = document.getElementById('proposal-list-siswa');
            const keuanganListSiswa = document.getElementById('keuangan-list-siswa');
            const totalPemasukanSiswaEl = document.getElementById('total-pemasukan-siswa');
            const totalPengeluaranSiswaEl = document.getElementById('total-pengeluaran-siswa');
            const saldoAkhirSiswaEl = document.getElementById('saldo-akhir-siswa');

            let studentId;

            function initSiswaView() {
                studentId = localStorage.getItem('studentId');
                if (!studentId) {
                    // Jika tidak ada studentId, kembali ke halaman login
                    showView(roleSelectionView);
                    return;
                }
                const studentData = getStudentData(studentId);
                const studentName = studentData ? studentData.name : 'Siswa';
                
                studentNameDisplay.textContent = `Selamat Datang, ${studentName}`;
                studentIdDisplay.textContent = `ID Sesi: ${studentId}`;
                renderStudentAppointments();
                renderSiswaChat();
                renderMateriListSiswa();
                renderProposalListSiswa();
                renderKeuanganListSiswa();
                showView(siswaView);
            }

            const renderStudentAppointments = () => {
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const myAppointments = allAppointments.filter(app => app.studentId === studentId).sort((a,b) => new Date(b.date) - new Date(a.date));
                appointmentList.innerHTML = '';
                if (myAppointments.length === 0) {
                    appointmentList.innerHTML = '<p class="text-slate-500 text-center">Belum ada janji temu.</p>';
                    return;
                }
                myAppointments.forEach(app => {
                    const date = new Date(app.date);
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-[#01579b] flex items-center justify-between';
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-blue-600">${app.topic}</p>
                            <p class="text-sm text-slate-500">${date.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}, ${date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})} WIB</p>
                        </div>
                        ${getStatusBadge(app.status)}`;
                    appointmentList.appendChild(el);
                });
            };

            const renderSiswaChat = () => {
                const allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                const myChat = allChats[studentId] || [];
                chatMessagesSiswa.innerHTML = '';
                myChat.forEach(chat => {
                    chatMessagesSiswa.innerHTML += renderChatMessage(chat.message, chat.sender);
                });
                chatMessagesSiswa.scrollTop = chatMessagesSiswa.scrollHeight;
            };

            const renderMateriListSiswa = () => {
                const materiList = JSON.parse(localStorage.getItem('materi') || '[]');
                materiListSiswa.innerHTML = '';
                if (materiList.length === 0) {
                    materiListSiswa.innerHTML = '<p class="text-center text-slate-500">Belum ada materi yang ditambahkan.</p>';
                    return;
                }
                materiList.forEach(materi => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-[#01579b] [transform:rotate(2deg)]';
                    el.innerHTML = `
                        <h4 class="font-bold text-lg text-cyan-600 mb-2">${materi.judul}</h4>
                        <p class="text-sm text-slate-700 leading-relaxed">${materi.konten}</p>
                    `;
                    materiListSiswa.appendChild(el);
                });
            };
            
            const renderProposalListSiswa = () => {
                const proposals = JSON.parse(localStorage.getItem('proposals') || '[]');
                proposalListSiswa.innerHTML = '';
                if (proposals.length === 0) {
                    proposalListSiswa.innerHTML = '<p class="text-center text-slate-500">Tidak ada proposal yang tersimpan.</p>';
                    return;
                }
                proposals.forEach(prop => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-blue-600';
                    el.innerHTML = `
                        <h4 class="font-bold text-lg text-blue-600">${prop.namaKegiatan}</h4>
                        <p class="text-sm text-slate-500">Anggaran: ${formatRupiah(prop.anggaran)}</p>
                        <p class="text-xs text-slate-700 mt-2">${prop.deskripsi}</p>
                    `;
                    proposalListSiswa.appendChild(el);
                });
            };

            const renderKeuanganListSiswa = () => {
                const keuangan = JSON.parse(localStorage.getItem('keuangan') || '[]');
                keuanganListSiswa.innerHTML = '';
                let totalPemasukan = 0;
                let totalPengeluaran = 0;

                if (keuangan.length === 0) {
                    keuanganListSiswa.innerHTML = '<p class="text-center text-slate-500">Tidak ada data keuangan yang tersimpan.</p>';
                } else {
                    keuangan.forEach(transaksi => {
                        const el = document.createElement('div');
                        const isPemasukan = transaksi.jenis === 'pemasukan';
                        const bgColor = isPemasukan ? 'bg-green-100' : 'bg-red-100';
                        const textColor = isPemasukan ? 'text-green-600' : 'text-red-600';
                        
                        if (isPemasukan) {
                            totalPemasukan += parseInt(transaksi.jumlah);
                        } else {
                            totalPengeluaran += parseInt(transaksi.jumlah);
                        }
                        
                        el.className = `p-4 ${bgColor} rounded-lg shadow-sm flex justify-between items-center border-2 border-[#01579b]`;
                        el.innerHTML = `
                            <div>
                                <h4 class="font-bold text-base ${textColor}">${isPemasukan ? '+' : '-'} ${formatRupiah(transaksi.jumlah)}</h4>
                                <p class="text-sm text-slate-700">${transaksi.deskripsi}</p>
                            </div>
                        `;
                        keuanganListSiswa.appendChild(el);
                    });
                }
                
                totalPemasukanSiswaEl.textContent = formatRupiah(totalPemasukan);
                totalPengeluaranSiswaEl.textContent = formatRupiah(totalPengeluaran);
                saldoAkhirSiswaEl.textContent = formatRupiah(totalPemasukan - totalPengeluaran);
            };

            appointmentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const studentData = getStudentData(studentId);
                const newAppointment = {
                    id: 'app-' + Date.now(), studentId, status: 'Menunggu',
                    name: studentData.name, // Ambil nama dari data akun
                    class: document.getElementById('kelas').value,
                    topic: document.getElementById('topik').value,
                    date: document.getElementById('tanggal').value,
                };
                allAppointments.push(newAppointment);
                localStorage.setItem('appointments', JSON.stringify(allAppointments));

                appointmentForm.reset();
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 3000);
                renderStudentAppointments();
            });

            sendBtnSiswa.addEventListener('click', () => {
                const message = chatInputSiswa.value.trim();
                if (message) {
                    let allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                    if (!allChats[studentId]) {
                        allChats[studentId] = [];
                    }
                    allChats[studentId].push({ message, sender: 'user', timestamp: Date.now() });
                    localStorage.setItem('chats', JSON.stringify(allChats));
                    chatInputSiswa.value = '';
                    renderSiswaChat();
                }
            });

            chatInputSiswa.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtnSiswa.click();
                }
            });

            siswaTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(siswaTabs, siswaTabContents, tab.getAttribute('data-tab'));
                    if (tab.getAttribute('data-tab') === 'chat') renderSiswaChat();
                    if (tab.getAttribute('data-tab') === 'materi') renderMateriListSiswa();
                    if (tab.getAttribute('data-tab') === 'transparansi') {
                        renderProposalListSiswa();
                        renderKeuanganListSiswa();
                    }
                });
            });

            // =============================
            // === LOGIKA UNTUK ADMIN ======
            // =============================
            const adminList = document.getElementById('admin-appointment-list');
            const refreshBtn = document.getElementById('refresh-btn');
            const chatStudentSelect = document.getElementById('chat-student-select');
            const chatMessagesAdmin = document.getElementById('chat-messages-admin');
            const chatInputAdmin = document.getElementById('chat-input-admin');
            const sendBtnAdmin = document.getElementById('send-btn-admin');
            const materiForm = document.getElementById('materi-form');
            const materiListAdmin = document.getElementById('materi-list-admin');
            const proposalForm = document.getElementById('proposal-form');
            const proposalListAdmin = document.getElementById('proposal-list-admin');
            const keuanganForm = document.getElementById('keuangan-form');
            const totalPemasukanAdminEl = document.getElementById('total-pemasukan-admin');
            const totalPengeluaranAdminEl = document.getElementById('total-pengeluaran-admin');
            const saldoAkhirAdminEl = document.getElementById('saldo-akhir-admin');
            const keuanganListAdmin = document.getElementById('keuangan-list-admin');
            const createUserForm = document.getElementById('create-user-form');
            const userListAdmin = document.getElementById('user-list-admin');

            let selectedStudentId = null;
            const adminPassword = 'admin123'; // Password admin

            function initAdminView() {
                renderAdminAppointments();
                renderAdminChatUsers();
                renderMateriListAdmin();
                renderProposalListAdmin();
                renderKeuanganListAdmin();
                renderUserListAdmin();
                showView(adminView);
            }
            
            const renderAdminAppointments = () => {
                const allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]').sort((a,b) => new Date(b.date) - new Date(a.date));
                adminList.innerHTML = '';
                if (allAppointments.length === 0) {
                    adminList.innerHTML = '<p class="text-slate-500 text-center py-8">Tidak ada janji temu yang masuk.</p>';
                    return;
                }
                allAppointments.forEach(app => {
                    const date = new Date(app.date);
                    const el = document.createElement('div');
                    el.className = 'bg-blue-50 border-4 border-[#01579b] p-4 rounded-lg grid grid-cols-1 md:grid-cols-4 gap-4 items-center [transform:rotate(2deg)]';
                    el.innerHTML = `
                        <div class="md:col-span-2">
                            <p class="font-bold text-blue-600">${app.name} <span class="font-normal text-slate-500">- ${app.class}</span></p>
                            <p class="text-sm text-cyan-600 font-bold">${app.topic}</p>
                        </div>
                        <div><p class="font-bold">${date.toLocaleDateString('id-ID', {day: 'numeric', month: 'long'})}, ${date.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</p>${getStatusBadge(app.status)}</div>
                        <div class="flex gap-2 justify-start md:justify-end">
                            ${app.status === 'Menunggu' ? `
                            <button data-id="${app.id}" data-action="approve" class="action-btn bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600 btn-water">Setujui</button>
                            <button data-id="${app.id}" data-action="reject" class="action-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 btn-water">Tolak</button>
                            ` : `<p class="text-sm text-slate-500">Telah direspon</p>`}
                        </div>`;
                    adminList.appendChild(el);
                });
            };

            const renderAdminChatUsers = () => {
                const studentAccounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                chatStudentSelect.innerHTML = '<option value="">Pilih Siswa...</option>';
                studentAccounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = acc.name;
                    chatStudentSelect.appendChild(option);
                });

                if (studentAccounts.length > 0) {
                    const currentSelection = chatStudentSelect.value;
                    if (!studentAccounts.find(s => s.id === currentSelection)) {
                        selectedStudentId = studentAccounts[0].id;
                        chatStudentSelect.value = selectedStudentId;
                    }
                    renderAdminChat();
                } else {
                    selectedStudentId = null;
                    chatMessagesAdmin.innerHTML = '<p class="text-center text-slate-500 mt-8">Belum ada chat yang masuk.</p>';
                }
            };
            
            const renderAdminChat = () => {
                if (!selectedStudentId) {
                    chatMessagesAdmin.innerHTML = '<p class="text-center text-slate-500 mt-8">Pilih siswa untuk melihat percakapan.</p>';
                    return;
                }
                const allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                const myChat = allChats[selectedStudentId] || [];
                chatMessagesAdmin.innerHTML = '';
                myChat.forEach(chat => {
                    chatMessagesAdmin.innerHTML += renderChatMessage(chat.message, chat.sender === 'user' ? 'user' : 'admin');
                });
                chatMessagesAdmin.scrollTop = chatMessagesAdmin.scrollHeight;
            };

            const renderMateriListAdmin = () => {
                const materiList = JSON.parse(localStorage.getItem('materi') || '[]');
                materiListAdmin.innerHTML = '';
                if (materiList.length === 0) {
                    materiListAdmin.innerHTML = '<p class="text-center text-slate-500">Tidak ada materi yang tersimpan.</p>';
                    return;
                }
                materiList.forEach(materi => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-cyan-600 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg text-cyan-600">${materi.judul}</h4>
                            <p class="text-sm text-slate-500 mt-1">${materi.konten.substring(0, 100)}...</p>
                        </div>
                        <button data-id="${materi.id}" class="delete-materi-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                             <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    materiListAdmin.appendChild(el);
                    lucide.createIcons();
                });
            };

            const renderProposalListAdmin = () => {
                const proposals = JSON.parse(localStorage.getItem('proposals') || '[]');
                proposalListAdmin.innerHTML = '';
                if (proposals.length === 0) {
                    proposalListAdmin.innerHTML = '<p class="text-center text-slate-500">Tidak ada proposal yang tersimpan.</p>';
                    return;
                }
                proposals.forEach(prop => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-blue-600 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg text-blue-600">${prop.namaKegiatan}</h4>
                            <p class="text-sm text-slate-500">Anggaran: ${formatRupiah(prop.anggaran)}</p>
                            <p class="text-xs text-slate-700 mt-1">${prop.deskripsi.substring(0, 100)}...</p>
                        </div>
                        <button data-id="${prop.id}" class="delete-proposal-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                             <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    proposalListAdmin.appendChild(el);
                    lucide.createIcons();
                });
            };

            const renderKeuanganListAdmin = () => {
                const keuangan = JSON.parse(localStorage.getItem('keuangan') || '[]');
                keuanganListAdmin.innerHTML = '';
                let totalPemasukan = 0;
                let totalPengeluaran = 0;

                if (keuangan.length === 0) {
                    keuanganListAdmin.innerHTML = '<p class="text-center text-slate-500">Tidak ada data keuangan yang tersimpan.</p>';
                } else {
                    keuangan.forEach(transaksi => {
                        const el = document.createElement('div');
                        const isPemasukan = transaksi.jenis === 'pemasukan';
                        const bgColor = isPemasukan ? 'bg-green-100' : 'bg-red-100';
                        const textColor = isPemasukan ? 'text-green-600' : 'text-red-600';
                        
                        if (isPemasukan) {
                            totalPemasukan += parseInt(transaksi.jumlah);
                        } else {
                            totalPengeluaran += parseInt(transaksi.jumlah);
                        }
                        
                        el.className = `p-4 ${bgColor} rounded-lg shadow-sm flex justify-between items-center border-2 border-[#01579b]`;
                        el.innerHTML = `
                            <div>
                                <h4 class="font-bold text-base ${textColor}">${isPemasukan ? '+' : '-'} ${formatRupiah(transaksi.jumlah)}</h4>
                                <p class="text-sm text-slate-700">${transaksi.deskripsi}</p>
                            </div>
                            <button data-id="${transaksi.id}" class="delete-keuangan-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        `;
                        keuanganListAdmin.appendChild(el);
                        lucide.createIcons();
                    });
                }
                
                totalPemasukanAdminEl.textContent = formatRupiah(totalPemasukan);
                totalPengeluaranAdminEl.textContent = formatRupiah(totalPengeluaran);
                saldoAkhirAdminEl.textContent = formatRupiah(totalPemasukan - totalPengeluaran);
            };

            const renderUserListAdmin = () => {
                const allAccounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                userListAdmin.innerHTML = '';
                if (allAccounts.length === 0) {
                    userListAdmin.innerHTML = '<p class="text-center text-slate-500">Belum ada akun siswa yang dibuat.</p>';
                    return;
                }
                allAccounts.forEach(acc => {
                    const el = document.createElement('div');
                    el.className = 'p-4 bg-white rounded-lg shadow-md border-2 border-purple-600 flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <h4 class="font-bold text-lg text-purple-600">${acc.name}</h4>
                            <p class="text-xs text-slate-500">Username: ${acc.username}</p>
                        </div>
                        <button data-id="${acc.id}" class="delete-user-btn bg-red-500 text-white p-2 rounded-full hover:bg-red-600 btn-water">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    `;
                    userListAdmin.appendChild(el);
                    lucide.createIcons();
                });
            };

            const updateAppointmentStatus = (id, newStatus) => {
                let allAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                const appIndex = allAppointments.findIndex(app => app.id === id);
                if (appIndex > -1) {
                    allAppointments[appIndex].status = newStatus;
                    localStorage.setItem('appointments', JSON.stringify(allAppointments));
                    renderAdminAppointments();
                }
            };
            
            adminList.addEventListener('click', (e) => {
                if (e.target.closest('.action-btn')) {
                    const btn = e.target.closest('.action-btn');
                    const id = btn.getAttribute('data-id');
                    const action = btn.getAttribute('data-action');
                    updateAppointmentStatus(id, action === 'approve' ? 'Dikonfirmasi' : 'Ditolak');
                }
            });

            refreshBtn.addEventListener('click', renderAdminAppointments);

            chatStudentSelect.addEventListener('change', (e) => {
                selectedStudentId = e.target.value;
                renderAdminChat();
            });

            sendBtnAdmin.addEventListener('click', () => {
                const message = chatInputAdmin.value.trim();
                if (message && selectedStudentId) {
                    let allChats = JSON.parse(localStorage.getItem('chats') || '{}');
                    if (!allChats[selectedStudentId]) {
                        allChats[selectedStudentId] = [];
                    }
                    allChats[selectedStudentId].push({ message, sender: 'admin', timestamp: Date.now() });
                    localStorage.setItem('chats', JSON.stringify(allChats));
                    chatInputAdmin.value = '';
                    renderAdminChat();
                }
            });
            
            chatInputAdmin.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendBtnAdmin.click();
                }
            });

            materiForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const allMateri = JSON.parse(localStorage.getItem('materi') || '[]');
                const newMateri = {
                    id: 'materi-' + Date.now(),
                    judul: document.getElementById('materi-judul').value,
                    konten: document.getElementById('materi-konten').value,
                };
                allMateri.push(newMateri);
                localStorage.setItem('materi', JSON.stringify(allMateri));
                materiForm.reset();
                renderMateriListAdmin();
                renderMateriListSiswa();
            });

            materiListAdmin.addEventListener('click', (e) => {
                if (e.target.closest('.delete-materi-btn')) {
                    const btn = e.target.closest('.delete-materi-btn');
                    const id = btn.getAttribute('data-id');
                    let allMateri = JSON.parse(localStorage.getItem('materi') || '[]');
                    allMateri = allMateri.filter(materi => materi.id !== id);
                    localStorage.setItem('materi', JSON.stringify(allMateri));
                    renderMateriListAdmin();
                    renderMateriListSiswa();
                }
            });

            proposalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const proposals = JSON.parse(localStorage.getItem('proposals') || '[]');
                const newProposal = {
                    id: 'proposal-' + Date.now(),
                    namaKegiatan: document.getElementById('proposal-nama-kegiatan').value,
                    deskripsi: document.getElementById('proposal-deskripsi').value,
                    anggaran: document.getElementById('proposal-anggaran').value,
                };
                proposals.push(newProposal);
                localStorage.setItem('proposals', JSON.stringify(proposals));
                proposalForm.reset();
                renderProposalListAdmin();
                renderProposalListSiswa();
            });

            proposalListAdmin.addEventListener('click', (e) => {
                if (e.target.closest('.delete-proposal-btn')) {
                    const btn = e.target.closest('.delete-proposal-btn');
                    const id = btn.getAttribute('data-id');
                    let proposals = JSON.parse(localStorage.getItem('proposals') || '[]');
                    proposals = proposals.filter(prop => prop.id !== id);
                    localStorage.setItem('proposals', JSON.stringify(proposals));
                    renderProposalListAdmin();
                    renderProposalListSiswa();
                }
            });

            keuanganForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const keuangan = JSON.parse(localStorage.getItem('keuangan') || '[]');
                const newTransaction = {
                    id: 'keuangan-' + Date.now(),
                    deskripsi: document.getElementById('keuangan-deskripsi').value,
                    jenis: document.getElementById('keuangan-jenis').value,
                    jumlah: document.getElementById('keuangan-jumlah').value,
                };
                keuangan.push(newTransaction);
                localStorage.setItem('keuangan', JSON.stringify(keuangan));
                keuanganForm.reset();
                renderKeuanganListAdmin();
                renderKeuanganListSiswa();
            });

            keuanganListAdmin.addEventListener('click', (e) => {
                if (e.target.closest('.delete-keuangan-btn')) {
                    const btn = e.target.closest('.delete-keuangan-btn');
                    const id = btn.getAttribute('data-id');
                    let keuangan = JSON.parse(localStorage.getItem('keuangan') || '[]');
                    keuangan = keuangan.filter(trans => trans.id !== id);
                    localStorage.setItem('keuangan', JSON.stringify(keuangan));
                    renderKeuanganListAdmin();
                    renderKeuanganListSiswa();
                }
            });

            createUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const accounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                const username = document.getElementById('user-username').value;

                if (accounts.some(acc => acc.username === username)) {
                    alert('Username sudah digunakan!');
                    return;
                }

                const newAccount = {
                    id: 'siswa-' + Date.now(),
                    name: document.getElementById('user-nama').value,
                    username: username,
                    password: document.getElementById('user-password').value,
                };
                accounts.push(newAccount);
                localStorage.setItem('studentAccounts', JSON.stringify(accounts));
                createUserForm.reset();
                renderUserListAdmin();
            });

            userListAdmin.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-user-btn');
                if (deleteBtn) {
                    const idToDelete = deleteBtn.getAttribute('data-id');
                    
                    let accounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                    accounts = accounts.filter(acc => acc.id !== idToDelete);
                    localStorage.setItem('studentAccounts', JSON.stringify(accounts));
                    
                    let appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
                    appointments = appointments.filter(app => app.studentId !== idToDelete);
                    localStorage.setItem('appointments', JSON.stringify(appointments));

                    let chats = JSON.parse(localStorage.getItem('chats') || '{}');
                    delete chats[idToDelete];
                    localStorage.setItem('chats', JSON.stringify(chats));

                    renderUserListAdmin();
                    renderAdminAppointments();
                    renderAdminChatUsers();
                }
            });

            adminTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(adminTabs, adminTabContents, tab.getAttribute('data-tab'));
                    if (tab.getAttribute('data-tab') === 'chat') renderAdminChatUsers();
                    if (tab.getAttribute('data-tab') === 'materi') renderMateriListAdmin();
                    if (tab.getAttribute('data-tab') === 'proposal') renderProposalListAdmin();
                    if (tab.getAttribute('data-tab') === 'keuangan') renderKeuanganListAdmin();
                    if (tab.getAttribute('data-tab') === 'users') renderUserListAdmin();
                });
            });

            // ======================================
            // === KONTROL NAVIGASI & INISIASI ======
            // ======================================
            showLoginSiswaBtn.addEventListener('click', () => showView(studentLoginView));
            showLoginAdminBtn.addEventListener('click', () => showView(adminLoginView));
            backToRoleBtns.forEach(btn => btn.addEventListener('click', () => showView(roleSelectionView)));

            studentLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = studentUsernameInput.value;
                const password = studentPasswordInput.value;
                const accounts = JSON.parse(localStorage.getItem('studentAccounts') || '[]');
                const account = accounts.find(acc => acc.username === username && acc.password === password);
                
                if (account) {
                    studentLoginError.classList.add('hidden');
                    localStorage.setItem('userRole', 'siswa');
                    localStorage.setItem('studentId', account.id);
                    initSiswaView();
                } else {
                    studentLoginError.classList.remove('hidden');
                }
            });
            
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (adminPasswordInput.value === adminPassword) {
                    adminLoginError.classList.add('hidden');
                    localStorage.setItem('userRole', 'admin');
                    initAdminView();
                } else {
                    adminLoginError.classList.remove('hidden');
                    adminPasswordInput.value = '';
                }
            });

            logoutBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('studentId');
                    showView(roleSelectionView);
                });
            });

            const savedRole = localStorage.getItem('userRole');
            if (savedRole === 'siswa') {
                initSiswaView();
            } else if (savedRole === 'admin') {
                initAdminView();
            } else {
                showView(roleSelectionView);
            }

            window.addEventListener('storage', (e) => {
                const currentRole = localStorage.getItem('userRole');
                if (e.key === 'studentAccounts' || e.key === 'appointments' || e.key === 'chats' || e.key === 'materi' || e.key === 'proposals' || e.key === 'keuangan') {
                    if (currentRole === 'siswa') {
                        initSiswaView();
                    } else if (currentRole === 'admin') {
                        initAdminView();
                    }
                }
            });

        });
    </script>
</body>
</html>

